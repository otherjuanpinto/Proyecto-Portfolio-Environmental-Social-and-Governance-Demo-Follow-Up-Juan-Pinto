---
title: "Green Coffee ESG Intelligence"
subtitle: "Comparative Analysis of Four Coffee Origins Using Open Data"
author: "Juan Paulo Pinto Sandoval"
date: today
date-format: "MMMM DD, YYYY"

format:
  html:
    toc: true
    toc-location: left
    toc-depth: 3
    number-sections: true
    theme: 
      - cosmo
      - custom.scss
    page-layout: article
    df-print: paged
    code-fold: true
    code-tools: false
    embed-resources: true

execute:
  echo: false
  warning: false
  message: false
  cache: false

knitr:
  opts_chunk:
    fig.align: 'center'
    out.width: '100%'
---

```{r}
#| label: setup-libraries
#| include: false

suppressPackageStartupMessages({
  library(readr)
  library(dplyr)
  library(tidyr)
  library(ggplot2)
  library(scales)
  library(janitor)
  library(knitr)
})
```

```{r}
#| label: setup-theme
#| include: false

# Paleta de colores por país (McKinsey-style)
country_colors <- c(
  "Brazil" = "#228B22",      # Verde oscuro (líder producción)
  "Colombia" = "#DAA520",    # Dorado (calidad premium)
  "Peru" = "#CD853F",        # Café claro (emergente)
  "Honduras" = "#8B4513"     # Café oscuro (robusto)
)

# Tema personalizado para gráficos
theme_consulting <- function() {
  theme_minimal(base_size = 13) +
    theme(
      plot.title = element_text(face = "bold", size = 16, color = "#1a252f"),
      plot.subtitle = element_text(size = 12, color = "#555555", margin = margin(b = 15)),
      plot.caption = element_text(size = 9, color = "#888888", hjust = 0),
      legend.position = "bottom",
      legend.title = element_text(face = "bold", size = 11),
      panel.grid.minor = element_blank(),
      panel.grid.major = element_line(color = "#e0e0e0", linewidth = 0.3),
      axis.title = element_text(face = "bold", size = 11),
      axis.text = element_text(color = "#555555")
    )
}
```

```{r}
#| label: load-data
#| include: false

# Cargar datasets procesados
full_data_raw <- read_csv("../data/processed/full_data.csv", show_col_types = FALSE)
esg_score_raw <- read_csv("../data/processed/esg_score.csv", show_col_types = FALSE)

# Limpiar nombres y estandarizar
full_data <- full_data_raw |>
  clean_names() |>
  select(
    country,
    year,
    production_tonnes,
    employment_agri_pct,
    rural_pop_growth_pct,
    investment_pct_gdp
  ) |>
  # Renombrar para consistencia en el reporte
  rename(
    production = production_tonnes,
    employment_agri = employment_agri_pct,
    rural_growth = rural_pop_growth_pct,
    investment = investment_pct_gdp
  )

esg_score <- esg_score_raw |>
  clean_names() |>
  arrange(desc(esg_score))

# Calcular estadísticas clave para Executive Summary
latest_year <- max(full_data$year, na.rm = TRUE)
key_stats <- full_data |>
  filter(year == latest_year) |>
  arrange(desc(production))
```

::: title-block
# Executive Summary

This report provides a **data-driven comparative analysis** of four major coffee-producing origins (Brazil, Colombia, Peru, and Honduras) using open-source indicators spanning **`r min(full_data$year, na.rm = TRUE)`–`r max(full_data$year, na.rm = TRUE)`**.

**Key objectives:**

-   Benchmark production capacity and trends
-   Assess social vulnerability through agricultural employment patterns
-   Evaluate macro-economic resilience via investment levels
-   Generate a transparent ESG-style composite score
:::

## Key Findings

```{r}
#| label: key-findings
#| results: asis

# Top 3 insights automáticos
top_producer <- esg_score$country[1]
top_esg <- esg_score$country[which.max(esg_score$esg_score)]

# Calcular tendencia de producción (últimos 5 años)
recent_growth <- full_data |>
  filter(year >= latest_year - 5) |>
  group_by(country) |>
  summarise(
    growth_rate = (last(production) - first(production)) / first(production) * 100,
    .groups = "drop"
  ) |>
  arrange(desc(growth_rate))

fastest_growing <- recent_growth$country[1]

cat("::: {.key-finding}\n")
cat("**Production Leadership:** ", top_producer, " dominates global green coffee production with ", 
    format(key_stats$production[1], big.mark = ","), " tonnes in ", latest_year, 
    " (", round(key_stats$production[1] / sum(key_stats$production) * 100, 1), "% of analyzed origins).\n", sep = "")
cat(":::\n\n")

cat("::: {.key-finding}\n")
cat("**Growth Trajectory:** ", fastest_growing, " shows the strongest recent growth momentum with a ", 
    round(recent_growth$growth_rate[1], 1), "% increase over the past 5 years.\n", sep = "")
cat(":::\n\n")

cat("::: {.key-finding}\n")
cat("**ESG Performance:** ", top_esg, " ranks highest in the composite ESG score (", 
    round(esg_score$esg_score[which.max(esg_score$esg_score)], 3), 
    "), balancing production capacity with lower social vulnerability.\n", sep = "")
cat(":::\n\n")
```

------------------------------------------------------------------------

# Business Context

## Why Coffee Matters

The global coffee industry represents a **\$200+ billion market** with profound socio-economic implications for producing regions. Coffee is a critical export commodity for Latin American economies, directly employing millions of smallholder farmers.

**ESG considerations in coffee sourcing:**

-   **Environmental:** Deforestation, water usage, biodiversity
-   **Social:** Labor conditions, rural poverty, gender equity
-   **Governance:** Transparency, certifications, supply chain traceability

This analysis focuses on **macro-level indicators** as transparent proxies for ESG performance, enabling comparative benchmarking without relying on proprietary certification data.

------------------------------------------------------------------------

# Data Foundations

## Methodology

**Data sources:**

1.  **Production data:** FAOSTAT (FAO Statistical Database)
    -   Indicator: Coffee, green (tonnes)
    -   Time series: `r min(full_data$year, na.rm = TRUE)`–`r max(full_data$year, na.rm = TRUE)`
2.  **Social indicators:** World Bank Open Data
    -   Employment in agriculture (% of total employment)
    -   Rural population growth (annual %)
3.  **Economic indicator:** World Bank Open Data
    -   Gross capital formation (% of GDP)

## Geographic Scope

```{r}
#| label: tbl-coverage
#| tbl-cap: "Dataset coverage by origin"

full_data |>
  group_by(country) |>
  summarise(
    `First Year` = min(year, na.rm = TRUE),
    `Last Year` = max(year, na.rm = TRUE),
    `Years Available` = n_distinct(year),
    `Data Points` = sum(!is.na(production)),
    .groups = "drop"
  ) |>
  arrange(country) |>
  kable(format.args = list(big.mark = ","))
```

------------------------------------------------------------------------

# Production Analysis

## Historical Production Trends

```{r}
#| label: fig-production-trends
#| fig-cap: "Coffee production evolution (tonnes, 2000-2023)"
#| fig-width: 10
#| fig-height: 6

full_data |>
  filter(!is.na(production)) |>
  ggplot(aes(x = year, y = production, color = country)) +
  geom_line(linewidth = 1.3, alpha = 0.9) +
  geom_point(size = 2, alpha = 0.6) +
  scale_color_manual(values = country_colors) +
  scale_y_continuous(
    labels = label_number(big.mark = ",", suffix = ""),
    breaks = scales::pretty_breaks(n = 6)
  ) +
  labs(
    title = "Coffee Production Trends by Origin",
    subtitle = "FAOSTAT green coffee production data (tonnes)",
    x = NULL,
    y = "Production (tonnes)",
    color = "Origin",
    caption = "Source: FAOSTAT"
  ) +
  theme_consulting()
```

## Market Share Analysis

```{r}
#| label: fig-market-share
#| fig-cap: "Production market share (latest year)"
#| fig-width: 8
#| fig-height: 6

key_stats |>
  mutate(
    share = production / sum(production) * 100,
    label = paste0(round(share, 1), "%")
  ) |>
  ggplot(aes(x = reorder(country, production), y = production, fill = country)) +
  geom_col(alpha = 0.85) +
  geom_text(aes(label = format(production, big.mark = ",")), 
            hjust = -0.1, size = 4, fontface = "bold") +
  coord_flip() +
  scale_fill_manual(values = country_colors) +
  scale_y_continuous(
    labels = label_number(big.mark = ","),
    expand = expansion(mult = c(0, 0.15))
  ) +
  labs(
    title = paste("Coffee Production Comparison (", latest_year, ")", sep = ""),
    subtitle = "Tonnes produced by origin",
    x = NULL,
    y = "Production (tonnes)",
    caption = "Source: FAOSTAT"
  ) +
  theme_consulting() +
  theme(legend.position = "none")
```

------------------------------------------------------------------------

# Social Indicators

## Agricultural Employment Dependency

**Interpretation:** Higher agricultural employment percentages indicate greater economic dependence on farming and potentially higher social vulnerability to commodity price shocks.

```{r}
#| label: fig-employment-agri
#| fig-cap: "Employment in agriculture (% of total employment)"
#| fig-width: 10
#| fig-height: 6

full_data |>
  filter(!is.na(employment_agri)) |>
  ggplot(aes(x = year, y = employment_agri, color = country)) +
  geom_line(linewidth = 1.3, alpha = 0.9) +
  geom_point(size = 2, alpha = 0.6) +
  scale_color_manual(values = country_colors) +
  scale_y_continuous(
    labels = label_number(suffix = "%"),
    breaks = scales::pretty_breaks(n = 6)
  ) +
  labs(
    title = "Agricultural Employment Trends",
    subtitle = "World Bank indicator: Employment in agriculture (% of total employment)",
    x = NULL,
    y = "% of Total Employment",
    color = "Origin",
    caption = "Source: World Bank (SL.AGR.EMPL.ZS)"
  ) +
  theme_consulting()
```

## Rural Population Dynamics

**Interpretation:** Rural population growth patterns reflect demographic pressure on agricultural land and infrastructure.

```{r}
#| label: fig-rural-growth
#| fig-cap: "Rural population growth (annual %)"
#| fig-width: 10
#| fig-height: 6

full_data |>
  filter(!is.na(rural_growth)) |>
  ggplot(aes(x = year, y = rural_growth, color = country)) +
  geom_line(linewidth = 1.3, alpha = 0.9) +
  geom_point(size = 2, alpha = 0.6) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "#888888", linewidth = 0.8) +
  scale_color_manual(values = country_colors) +
  scale_y_continuous(
    labels = label_number(suffix = "%"),
    breaks = scales::pretty_breaks(n = 8)
  ) +
  labs(
    title = "Rural Population Growth Trends",
    subtitle = "World Bank indicator: Rural population growth (annual %)",
    x = NULL,
    y = "Annual Growth (%)",
    color = "Origin",
    caption = "Source: World Bank (SP.RUR.TOTL.ZG)"
  ) +
  theme_consulting()
```

------------------------------------------------------------------------

# Economic Performance

## Investment Capacity

**Interpretation:** Gross capital formation as % of GDP serves as a proxy for macro-economic capacity to invest in productivity improvements, infrastructure, and resilience.

```{r}
#| label: fig-investment
#| fig-cap: "Gross capital formation (% of GDP)"
#| fig-width: 10
#| fig-height: 6

full_data |>
  filter(!is.na(investment)) |>
  ggplot(aes(x = year, y = investment, color = country)) +
  geom_line(linewidth = 1.3, alpha = 0.9) +
  geom_point(size = 2, alpha = 0.6) +
  scale_color_manual(values = country_colors) +
  scale_y_continuous(
    labels = label_number(suffix = "%"),
    breaks = scales::pretty_breaks(n = 6)
  ) +
  labs(
    title = "Investment Levels by Origin",
    subtitle = "World Bank indicator: Gross capital formation (% of GDP)",
    x = NULL,
    y = "% of GDP",
    color = "Origin",
    caption = "Source: World Bank (NE.GDI.TOTL.ZS)"
  ) +
  theme_consulting()
```

------------------------------------------------------------------------

# ESG Composite Scoring

## Methodology

The **ESG composite score** is calculated using normalized 5-year averages of four indicators:

| Component | Weight | Direction | Rationale |
|------------------|-----------------|------------------|------------------|
| **Production** | 35% | Positive (+) | Economic scale and market relevance |
| **Agricultural Employment** | 30% | Negative (–) | Lower dependency = lower vulnerability |
| **Rural Growth** | 15% | Negative (–) | Lower growth = less demographic pressure |
| **Investment** | 20% | Positive (+) | Higher investment = greater resilience capacity |

**Normalization:** All indicators are scaled to \[0, 1\] using min-max normalization across the four origins.

## ESG Rankings

```{r}
#| label: tbl-esg-score
#| tbl-cap: "ESG composite score by origin"

esg_score |>
  select(
    Country = country,
    `Avg Production` = avg_production,
    `Avg Employment (%)` = avg_employment_agri,
    `Avg Rural Growth (%)` = avg_rural_growth,
    `Avg Investment (%)` = avg_investment,
    `ESG Score` = esg_score
  ) |>
  mutate(
    `Avg Production` = format(round(`Avg Production`, 0), big.mark = ","),  # ✅ Corregido
    `Avg Employment (%)` = round(`Avg Employment (%)`, 1),
    `Avg Rural Growth (%)` = round(`Avg Rural Growth (%)`, 2),
    `Avg Investment (%)` = round(`Avg Investment (%)`, 1),
    `ESG Score` = round(`ESG Score`, 3)
  ) |>
  kable(align = c("l", "r", "r", "r", "r", "r"))
```

## Visual Comparison

```{r}
#| label: fig-esg-score
#| fig-cap: "ESG composite score ranking (higher = stronger ESG performance)"
#| fig-width: 9
#| fig-height: 6

esg_score |>
  ggplot(aes(x = reorder(country, esg_score), y = esg_score, fill = country)) +
  geom_col(alpha = 0.85, width = 0.7) +
  geom_text(aes(label = round(esg_score, 3)), 
            hjust = -0.2, size = 5, fontface = "bold") +
  coord_flip() +
  scale_fill_manual(values = country_colors) +
  scale_y_continuous(
    limits = c(0, 1),
    breaks = seq(0, 1, 0.2),
    expand = expansion(mult = c(0, 0.15))
  ) +
  labs(
    title = "ESG Composite Score Rankings",
    subtitle = "5-year average normalized scoring model",
    x = NULL,
    y = "ESG Score (0 = lowest, 1 = highest)",
    caption = "Methodology: Weighted average of normalized indicators"
  ) +
  theme_consulting() +
  theme(legend.position = "none")
```

------------------------------------------------------------------------

# Strategic Recommendations

## By Origin

```{r}
#| label: recommendations
#| results: asis

for (i in 1:nrow(esg_score)) {
  country_name <- esg_score$country[i]
  score <- round(esg_score$esg_score[i], 3)
  rank <- i
  
  cat("### ", country_name, " (ESG Score: ", score, ")\n\n", sep = "")
  
  if (rank == 1) {
    cat("**Strengths:** Highest ESG performance; balanced production capacity with lower social vulnerability.\n\n")
    cat("**Opportunities:** Leverage ESG leadership for premium market positioning and sustainable sourcing partnerships.\n\n")
  } else if (rank == nrow(esg_score)) {
    cat("**Challenges:** Lower ESG score driven by higher agricultural employment dependency.\n\n")
    cat("**Opportunities:** Focus on economic diversification and productivity improvements to reduce vulnerability.\n\n")
  } else {
    cat("**Performance:** Mid-tier ESG performance with room for improvement.\n\n")
    cat("**Opportunities:** Target specific indicator improvements (employment, investment, or rural growth).\n\n")
  }
  
  cat("---\n\n")
}
```

## General Insights

1.  **Production vs. Vulnerability Trade-off:** Larger producers tend to show lower agricultural employment percentages, suggesting economic diversification benefits.

2.  **Investment Matters:** Origins with higher investment-to-GDP ratios demonstrate greater capacity for infrastructure and productivity improvements.

3.  **Data Transparency:** This framework can be extended with environmental (deforestation, water stress) and governance (rule of law, corruption) indicators for a more comprehensive ESG assessment.

------------------------------------------------------------------------

# Limitations & Next Steps

## Current Limitations

-   **Macro-level indicators** do not capture farm-level realities or certification status
-   **Missing environmental data** (forest loss, emissions, biodiversity)
-   **No governance metrics** (corruption, rule of law, labor regulations)
-   **Temporal lag** in World Bank data availability

## Recommended Enhancements

1.  **Add environmental layer:**
    -   Forest cover change (Global Forest Watch)
    -   Water stress indicators (WRI Aqueduct)
    -   Carbon emissions intensity
2.  **Incorporate governance:**
    -   Corruption Perception Index (Transparency International)
    -   Rule of Law Index (World Justice Project)
    -   Labor rights scores (ITUC Global Rights Index)
3.  **Farm-level validation:**
    -   Cross-reference with certification data (Fairtrade, Rainforest Alliance)
    -   Add qualitative case studies from producer cooperatives

------------------------------------------------------------------------

# Appendix

## Technical Notes

-   **Data processing:** All datasets cleaned using R (tidyverse ecosystem)
-   **Reproducibility:** Full pipeline available in `scripts/01_pipeline_green_coffee_esg.R`
-   **Normalization:** Min-max scaling applied independently to each indicator
-   **Missing data:** Handled via `na.rm = TRUE` in aggregations

## Data Access

All source data is publicly available:

-   FAOSTAT: <https://www.fao.org/faostat/>
-   World Bank Open Data: <https://data.worldbank.org/>

------------------------------------------------------------------------

**Report generated:** `r Sys.time()`

**Author:** Juan Paulo Pinto Sandoval\
**Project:** Green Coffee ESG Intelligence
