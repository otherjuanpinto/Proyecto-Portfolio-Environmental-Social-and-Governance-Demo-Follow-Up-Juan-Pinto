---
project:
  type: website

format:
  html:
    theme: cosmo
    toc: true
    toc-depth: 3
    number-sections: true
    df-print: paged

execute:
  echo: false
  warning: false
  message: false

---

---
title: "Green Coffee ESG Pipeline"
subtitle: "FAOSTAT + World Bank | Multi-origin benchmarking"
author: "Juan Paulo Pinto Sandoval"
date: today
format:
  html:
    toc: true
    toc-depth: 3
    number-sections: true
---

## Executive Summary

This report benchmarks four coffee origins (Brazil, Colombia, Peru, Honduras) using: - Coffee production (FAOSTAT) - Employment in agriculture (% of total employment) - Rural population growth (%) - Gross capital formation (% GDP)

The purpose is to build a transparent ESG-style comparative signal for green coffee sourcing.

------------------------------------------------------------------------

```{r}
#| label: setup
#| include: false

suppressPackageStartupMessages({
  library(readr)
  library(dplyr)
  library(tidyr)
  library(ggplot2)
  library(scales)
  library(janitor)
})
```

```{r}
#| label: load-data
#| include: false

# Cargar datasets procesados
full_data_raw <- read_csv("../data/processed/full_data.csv", show_col_types = FALSE)
esg_score_raw <- read_csv("../data/processed/esg_score.csv", show_col_types = FALSE)

# Limpiar y estandarizar full_data
full_data <- full_data_raw |>
  janitor::clean_names() |>
  select(
    country,
    year,
    production_tonnes,
    employment_agri_pct,
    rural_pop_growth_pct,
    investment_pct_gdp
  ) |>
  # Renombrar para usar en gráficos
  rename(
    production = production_tonnes,
    employment_agri = employment_agri_pct,
    rural_growth = rural_pop_growth_pct,
    investment = investment_pct_gdp
  ) |>
  # Filtrar filas con datos válidos
  filter(!is.na(country), !is.na(year))

# Limpiar esg_score
esg_score <- esg_score_raw |>
  janitor::clean_names() |>
  arrange(desc(esg_score))

# Calcular estadísticas clave para Executive Summary
latest_year <- max(full_data$year, na.rm = TRUE)

key_stats <- full_data |>
  filter(year == latest_year) |>
  filter(!is.na(production)) |>
  arrange(desc(production))
```

Data Coverage'

```{r}
#| label: coverage-table

report_data |>
  group_by(country) |>
  summarise(
    min_year = min(year, na.rm = TRUE),
    max_year = max(year, na.rm = TRUE),
    n_years = n_distinct(year),
    .groups = "drop"
  ) |>
  arrange(country)

```

# Production (FAOSTAT)

## Coffee production trends

```{r}
#| label: fig-production
#| fig-cap: "Coffee production (tonnes)"
#| fig-width: 9
#| fig-height: 5

report_data |>
  ggplot(aes(x = year, y = production_tonnes, color = country)) +
  geom_line(linewidth = 1.1) +
  scale_y_continuous(labels = label_number(big.mark = ",")) +
  labs(
    title = "Coffee production trends",
    subtitle = "FAOSTAT production (tonnes)",
    x = "Year",
    y = "Tonnes",
    color = "Origin"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "bottom")

```

# Social Exposure

## Employment in agriculture

**Interpretation:**\
Higher employment in agriculture suggests stronger rural dependency and potentially higher exposure to social vulnerability.

```{r}
#| label: fig-employment
#| fig-cap: "Employment in agriculture (% of total employment)"
#| fig-width: 9
#| fig-height: 5

report_data |>
  ggplot(aes(x = year, y = employment_agri, color = country)) +
  geom_line(linewidth = 1.1) +
  scale_y_continuous(labels = label_number(suffix = "%")) +
  labs(
    title = "Employment in agriculture",
    subtitle = "World Bank indicator SL.AGR.EMPL.ZS",
    x = "Year",
    y = "% of total employment",
    color = "Origin"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "bottom")

```

# Rural Dynamics

## Rural population growth

**Interpretation:**\
Higher rural growth can reflect demographic pressure and potential land-use stress.

```{r}
#| label: fig-rural-growth
#| fig-cap: "Rural population growth (%)"
#| fig-width: 9
#| fig-height: 5

report_data |>
  ggplot(aes(x = year, y = rural_growth, color = country)) +
  geom_line(linewidth = 1.1) +
  scale_y_continuous(labels = label_number(suffix = "%")) +
  labs(
    title = "Rural population growth",
    subtitle = "World Bank indicator SP.RUR.TOTL.ZG",
    x = "Year",
    y = "%",
    color = "Origin"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "bottom")

```

# Macro Capacity

## Investment (% GDP)

**Interpretation:**\
Higher investment levels suggest stronger macro capacity to fund infrastructure and productivity improvements.

```{r}
#| label: fig-investment
#| fig-cap: "Gross capital formation (% of GDP)"
#| fig-width: 9
#| fig-height: 5

report_data |>
  ggplot(aes(x = year, y = investment, color = country)) +
  geom_line(linewidth = 1.1) +
  scale_y_continuous(labels = label_number(suffix = "%")) +
  labs(
    title = "Investment (% GDP)",
    subtitle = "World Bank indicator NE.GDI.TOTL.ZS",
    x = "Year",
    y = "% of GDP",
    color = "Origin"
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "bottom")

```

# ESG Composite Score

## Score overview

This score is a transparent composite index using 5-year averages:

-    Production (positive)

-   Employment in agriculture (negative)

-    Rural growth (negative)

-    Investment (positive)

```{r}
#| label: esg-table

esg_score |>
  arrange(desc(esg_score))

```

ESG Score bar chart

```{r}

```

# Notes & Limitations

-    This model is a **benchmarking signal**, not a full ESG certification

-    Indicators are macro-level and do not capture farm-level realities.

-    Results depend on data availability and the last 5-year window.

# Next Steps

-    Add Environmental indicators (forest loss, emissions, water stress)

-    Add governance proxies (rule of law, corruption perception)

-    Build a sourcing recommendation layer

```{r}
#| label: fig-esg-score
#| fig-cap: "ESG composite score (higher = stronger macro + lower exposure)"
#| fig-width: 8
#| fig-height: 5

esg_score |>
  ggplot(aes(x = reorder(country, esg_score), y = esg_score)) +
  geom_col() +
  coord_flip() +
  scale_y_continuous(labels = label_number(accuracy = 0.01)) +
  labs(
    title = "ESG composite score",
    subtitle = "5-year normalized scoring model",
    x = NULL,
    y = "Score (0–1)"
  ) +
  theme_minimal(base_size = 12)

```
